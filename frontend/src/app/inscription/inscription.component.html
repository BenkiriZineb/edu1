<form (ngSubmit)="onSubmit()" #form="ngForm" novalidate>
  <!-- Messages d'erreur et de succès en haut -->
  @if (errorMessage) {
    <div class="alert alert-danger alert-dismissible">
      <strong>Erreur :</strong> {{ errorMessage }}
      <button type="button" class="btn-close" (click)="closeMessage('error')" aria-label="Fermer">×</button>
    </div>
  }

  @if (successMessage) {
    <div class="alert alert-success alert-dismissible">
      <strong>Succès :</strong> {{ successMessage }}
      <button type="button" class="btn-close" (click)="closeMessage('success')" aria-label="Fermer">×</button>
    </div>
  }

  <!-- Champs communs -->
  <div class="form-group">
    <label for="nom">Nom :</label>
    <input 
      type="text" 
      id="nom"
      name="nom" 
      [(ngModel)]="utilisateur.nom" 
      #nom="ngModel"
      required
      class="form-control"
      [class.is-invalid]="nom.invalid && nom.touched">
    @if (nom.invalid && nom.touched) {
      <div class="invalid-feedback">
        Le nom est requis.
      </div>
    }
  </div>
  
  <div class="form-group">
    <label for="prenom">Prénom :</label>
    <input 
      type="text" 
      id="prenom"
      name="prenom" 
      [(ngModel)]="utilisateur.prenom" 
      #prenom="ngModel"
      required
      class="form-control"
      [class.is-invalid]="prenom.invalid && prenom.touched">
    @if (prenom.invalid && prenom.touched) {
      <div class="invalid-feedback">
        Le prénom est requis.
      </div>
    }
  </div>
  
  <div class="form-group">
    <label for="email">Email :</label>
    <input 
      type="email" 
      id="email"
      name="email" 
      [(ngModel)]="utilisateur.email" 
      #email="ngModel"
      required
      email
      class="form-control"
      [class.is-invalid]="email.invalid && email.touched">
    @if (email.invalid && email.touched) {
      <div class="invalid-feedback">
        @if (email.errors?.['required']) {
          <div>L'email est requis.</div>
        }
        @if (email.errors?.['email']) {
          <div>Format d'email invalide.</div>
        }
      </div>
    }
  </div>
  
  <div class="form-group">
    <label for="mdp">Mot de passe :</label>
    <input 
      type="password" 
      id="mdp"
      name="mdp" 
      [(ngModel)]="utilisateur.mdp" 
      #mdp="ngModel"
      required
      minlength="6"
      class="form-control"
      [class.is-invalid]="mdp.invalid && mdp.touched">
    @if (mdp.invalid && mdp.touched) {
      <div class="invalid-feedback">
        @if (mdp.errors?.['required']) {
          <div>Le mot de passe est requis.</div>
        }
        @if (mdp.errors?.['minlength']) {
          <div>Le mot de passe doit contenir au moins 6 caractères.</div>
        }
      </div>
    }
  </div>
  
  <div class="form-group">
    <label for="sexe">Sexe :</label>
    <select 
      id="sexe"
      name="sexe" 
      [(ngModel)]="utilisateur.sexe" 
      #sexe="ngModel"
      required
      class="form-control"
      [class.is-invalid]="sexe.invalid && sexe.touched">
      <option value="" disabled>Sélectionnez le sexe</option>
      @for (sexeOption of sexes; track sexeOption.value) {
        <option [value]="sexeOption.value">{{sexeOption.label}}</option>
      }
    </select>
    @if (sexe.invalid && sexe.touched) {
      <div class="invalid-feedback">
        Veuillez sélectionner le sexe.
      </div>
    }
  </div>
  
  <!-- Date de naissance -->
  <div class="form-group">
    <label for="datedenaissance">Date de naissance :</label>
    <input type="date" id="datedenaissance" name="datedenaissance"
           [(ngModel)]="utilisateur.datedenaissance" #datedenaissance="ngModel"
           required class="form-control"
           [class.is-invalid]="datedenaissance.invalid && datedenaissance.touched">
    <div *ngIf="datedenaissance.invalid && datedenaissance.touched" class="invalid-feedback">
      La date de naissance est requise.
    </div>
  </div>

  <!-- Adresse -->
  
  <div class="form-group">
  <label for="adresse">Adresse :</label>
  <input type="text" id="adresse" name="adresse"
         [(ngModel)]="utilisateur.adresse" #adresse="ngModel"
         required class="form-control"
         [class.is-invalid]="adresse.invalid && adresse.touched">
  <div *ngIf="adresse.invalid && adresse.touched" class="invalid-feedback">
    L'adresse est requise.
  </div>
</div>


  <div class="form-group">
    <label for="role">Rôle :</label>
    <select 
      id="role"
      name="role" 
      [(ngModel)]="utilisateur.role" 
      #role="ngModel"
      required 
      (change)="onRoleChange()"
      class="form-control"
      [class.is-invalid]="role.invalid && role.touched">
      <option value="" disabled>Sélectionnez un rôle</option>
      @for (roleOption of roles; track roleOption.value) {
        <option [value]="roleOption.value">{{roleOption.label}}</option>
      }
    </select>
    @if (role.invalid && role.touched) {
      <div class="invalid-feedback">
        Veuillez sélectionner un rôle.
      </div>
    }
  </div>

  <!-- Champs spécifiques à l'Élève -->
  @if (utilisateur.role === 'ELEVE') {
    <div class="role-specific-fields">
      <h4>Informations Élève</h4>
      
      <div class="form-group">
        <label for="niveauScolaire">Niveau scolaire :</label>
        <select 
          id="niveauScolaire"
          name="niveauScolaire" 
          [(ngModel)]="eleveData.niveauScolaire" 
          #niveauScolaire="ngModel"
          required
          class="form-control"
          [class.is-invalid]="niveauScolaire.invalid && niveauScolaire.touched">
          <option value="" disabled>Sélectionnez un niveau</option>
          @for (niveau of niveauxScolaires; track niveau) {
            <option [value]="niveau">{{niveau}}</option>
          }
        </select>
        @if (niveauScolaire.invalid && niveauScolaire.touched) {
          <div class="invalid-feedback">
            Le niveau scolaire est requis.
          </div>
        }
      </div>
      
      <div class="form-group">
        <label for="parentId">ID Parent (optionnel) :</label>
        <input 
          type="number" 
          id="parentId"
          name="parentId" 
          [(ngModel)]="eleveData.parentId"
          class="form-control"
          min="1"
          placeholder="Laisser vide si non applicable">
      </div>
    </div>
  }

  <!-- Champs spécifiques au Parent -->
  @if (utilisateur.role === 'PARENT') {
    <div class="role-specific-fields">
      <h4>Informations Parent</h4>
      
      <div class="form-group">
        <label for="nbr_enfant">Nombre d'enfants :</label>
        <input 
          type="number" 
          id="nbr_enfant"
          name="nbr_enfant" 
          [(ngModel)]="parentData.nbr_enfant" 
          #nbrEnfant="ngModel"
          required
          min="1"
          class="form-control"
          [class.is-invalid]="nbrEnfant.invalid && nbrEnfant.touched">
        @if (nbrEnfant.invalid && nbrEnfant.touched) {
          <div class="invalid-feedback">
            @if (nbrEnfant.errors?.['required']) {
              <div>Le nombre d'enfants est requis.</div>
            }
            @if (nbrEnfant.errors?.['min']) {
              <div>Le nombre d'enfants doit être au moins 1.</div>
            }
          </div>
        }
      </div>
    </div>
  }

  <!-- Champs spécifiques au Professeur -->
  @if (utilisateur.role === 'PROFESSEUR') {
    <div class="role-specific-fields">
      <h4>Informations Professeur</h4>
      
      <div class="form-group">
        <label>Matières enseignées :</label>
        <div class="checkbox-group" [class.is-invalid]="!hasSelectedMatieres && form.submitted">
          @for (matiere of listeMatieres; track matiere) {
            <div class="form-check">
              <input 
                type="checkbox" 
                class="form-check-input"
                [id]="'matiere-' + matiere" 
                [checked]="professeurData.matieresEnseignees.includes(matiere)"
                (change)="onMatiereChange(matiere, $event)">
              <label class="form-check-label" [for]="'matiere-' + matiere">
                {{matiere}}
              </label>
            </div>
          }
        </div>
        @if (!hasSelectedMatieres && form.submitted) {
          <div class="invalid-feedback d-block">
            Veuillez sélectionner au moins une matière.
          </div>
        }
      </div>
    </div>
  }

  

  <!-- Bouton de soumission -->
  <div class="form-actions">
    <button 
      type="submit" 
      class="btn btn-primary btn-lg"
      [disabled]="form.invalid || isLoading || !isFormValid()">
      @if (isLoading) {
        <span class="spinner-border spinner-border-sm me-2"></span>
      }
      {{ isLoading ? 'Création en cours...' : 'Créer le compte' }}
    </button>
  </div>
</form>